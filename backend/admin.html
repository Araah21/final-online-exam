<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Admin Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0056b3;
            --success-color: #218838;
            --danger-color: #c82333;
            --warning-color: #e0a800;
            --info-color: #138496;
            --light-gray: #f8f9fa;
            --medium-gray: #dee2e6;
            --dark-gray: #343a40;
            --white: #fff;
        }
        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.7;
            background-color: var(--light-gray);
            color: #212529;
            margin: 0;
            padding: 20px;
            font-size: 16px;
        }
        .container { max-width: 1400px; margin: auto; }
        h1, h2 { color: var(--dark-gray); border-bottom: 1px solid var(--medium-gray); padding-bottom: 10px; font-weight: 600; }
        h1 { font-size: 2rem; border-bottom-width: 2px; border-bottom-color: var(--primary-color); margin-bottom: 20px; }
        h2 { font-size: 1.5rem; margin-top: 30px; }
        .card-deck { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--white); padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); text-align: center; }
        .card h3 { margin-top: 0; font-size: 1.1rem; color: #6c757d; font-weight: 500; }
        .card .stat { font-size: 2.75rem; font-weight: 700; color: var(--primary-color); }
        .tabs { display: flex; border-bottom: 1px solid var(--medium-gray); margin-bottom: 20px; flex-wrap: wrap; }
        .tab-button { background: none; border: none; padding: 12px 25px; font-size: 1.1rem; font-family: 'Poppins', sans-serif; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; }
        .tab-button.active { border-bottom-color: var(--primary-color); font-weight: 600; color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { background: var(--white); padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .table-wrapper { overflow-x: auto; }
        .controls { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.9rem; margin-bottom: 4px; color: #6c757d; font-weight: 500; }
        .search-box, .filter-select { padding: 10px; font-size: 1rem; font-family: 'Poppins', sans-serif; border: 1px solid var(--medium-gray); border-radius: 5px; }
        .search-box { min-width: 250px; }
        .btn { padding: 10px 20px; font-size: 1rem; cursor: pointer; text-decoration: none; color: var(--white); border: none; border-radius: 5px; transition: all 0.2s ease; font-family: 'Poppins', sans-serif; font-weight: 500; }
        .btn:active { transform: translateY(1px); }
        .btn-download { background-color: var(--success-color); }
        .btn-clear { background-color: var(--danger-color); }
        .btn-delete, .btn-retake { font-size: 0.9rem; padding: 8px 12px; }
        .btn-delete { background-color: var(--warning-color); color: #212529; }
        .btn-retake { background-color: var(--info-color); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 1rem; }
        th, td { padding: 14px; border: 1px solid var(--medium-gray); text-align: left; white-space: nowrap; }
        th { background-color: var(--light-gray); font-weight: 600; }
        th.sortable { cursor: pointer; }
        th.sortable:hover { background-color: #e2e6ea; }
        .sort-arrow { display: inline-block; margin-left: 8px; opacity: 0.5; }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination button { margin: 0 5px; }
        .status-completed { color: var(--success-color); font-weight: 600; }
        .status-in-progress { color: var(--warning-color); font-weight: 600; }
        .status-not-taken { color: #6c757d; }
        .loader { text-align: center; padding: 40px; font-size: 1.2rem; color: #6c757d; }
        @media (max-width: 768px) {
            body { padding: 10px; } .controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exam Admin Dashboard</h1>
        <div class="card-deck" id="summary-cards"><!-- Summary Cards --></div>
        <div class="tabs">
            <button class="tab-button active" data-tab="roster">Student Roster</button>
            <button class="tab-button" data-tab="results">Exam Results</button>
            <button class="tab-button" data-tab="analysis">Question Analysis</button>
        </div>

        <!-- Student Roster Tab -->
        <div id="roster" class="tab-content active">
            <div class="table-container">
                <h2>Student Roster & Status</h2>
                <div class="controls">
                    <div class="filter-group">
                        <label for="search-students">Search Name/ID</label>
                        <input type="search" id="search-students" class="search-box" placeholder="Search...">
                    </div>
                    <div class="filter-group">
                        <label for="roster-filter-course">Course</label>
                        <select id="roster-filter-course" class="filter-select"><option value="all">All Courses</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="roster-filter-section">Section</label>
                        <select id="roster-filter-section" class="filter-select"><option value="all">All Sections</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="roster-rows-per-page">Show</label>
                        <select id="roster-rows-per-page" class="filter-select">
                            <option value="10">10 Rows</option><option value="25">25 Rows</option><option value="50">50 Rows</option><option value="100">100 Rows</option>
                        </select>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="students-table">
                        <thead><tr><th class="sortable" data-sort-key="lastname">Student Name <span class="sort-arrow"></span></th><th>ID Number</th><th>Course</th><th>Section</th><th>Exam Status</th><th>Action</th></tr></thead>
                        <tbody id="students-tbody"></tbody>
                    </table>
                </div>
                <div class="pagination" id="students-pagination"></div>
            </div>
        </div>

        <!-- Exam Results Tab -->
        <div id="results" class="tab-content">
            <div class="table-container">
                <h2>Exam Results</h2>
                <div class="controls">
                    <div class="filter-group">
                        <label for="results-filter-course">Course</label>
                        <select id="results-filter-course" class="filter-select"><option value="all">All Courses</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="results-filter-section">Section</label>
                        <select id="results-filter-section" class="filter-select"><option value="all">All Sections</option></select>
                    </div>
                     <div class="filter-group">
                        <label for="results-rows-per-page">Show</label>
                        <select id="results-rows-per-page" class="filter-select">
                            <option value="10">10 Rows</option><option value="25">25 Rows</option><option value="50">50 Rows</option><option value="100">100 Rows</option>
                        </select>
                    </div>
                    <a href="/download-results" class="btn btn-download" style="margin-left: auto;">Download All as CSV</a>
                </div>
                <div class="table-wrapper">
                    <table id="results-table">
                        <thead><tr><th>Name</th><th>Course</th><th>Section</th><th class="sortable" data-sort-key="score">Score <span class="sort-arrow"></span></th><th>Exam Title</th><th>Submitted At</th><th>Action</th></tr></thead>
                        <tbody id="results-tbody"></tbody>
                    </table>
                </div>
                 <div class="pagination" id="results-pagination"></div>
            </div>
        </div>

        <!-- Question Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="table-container">
                <h2>Accounting Information System - Question Analysis</h2>
                <div class="table-wrapper">
                    <table id="analysis-table-ais">
                        <thead><tr><th>Question</th><th>Total Attempts</th><th>Correct Answers</th><th>Success Rate</th></tr></thead>
                        <tbody id="analysis-tbody-ais"></tbody>
                    </table>
                </div>
                
                <h2>Network Operating System - Question Analysis</h2>
                <div class="table-wrapper">
                    <table id="analysis-table-nos">
                        <thead><tr><th>Question</th><th>Total Attempts</th><th>Correct Answers</th><th>Success Rate</th></tr></thead>
                        <tbody id="analysis-tbody-nos"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let allStudents = [], allResults = [], allAnalysis = [];
        let adminKey = '';
        const viewState = {
            roster: { data: [], currentPage: 1, rowsPerPage: 10, sortBy: 'lastname', sortDir: 'asc', filters: { course: 'all', section: 'all', search: '' } },
            results: { data: [], currentPage: 1, rowsPerPage: 10, sortBy: 'score', sortDir: 'desc', filters: { course: 'all', section: 'all' } },
        };

        // --- DOM ELEMENTS ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initializeDashboard);
        
        async function initializeDashboard() {
            // Show loading states
            document.getElementById('students-tbody').innerHTML = `<tr><td colspan="6" class="loader">Loading...</td></tr>`;
            document.getElementById('results-tbody').innerHTML = `<tr><td colspan="7" class="loader">Loading...</td></tr>`;

            try {
                const [studentsRes, resultsRes, analysisRes] = await Promise.all([
                    fetch('/api/students'),
                    fetch('/api/results'),
                    fetch('/api/analysis')
                ]);
                allStudents = await studentsRes.json();
                allResults = await resultsRes.json();
                allAnalysis = await analysisRes.json();

                populateFilters();
                updateAllViews();
                updateSummaryCards();
            } catch (error) {
                console.error("Failed to initialize dashboard:", error);
                alert("Failed to load dashboard data. Please refresh.");
            }
        }

        function populateFilters() {
            const courses = [...new Set(allStudents.map(s => s.course))].filter(Boolean);
            const sections = [...new Set(allStudents.map(s => s.section))].filter(Boolean);
            const courseSelects = document.querySelectorAll('#roster-filter-course, #results-filter-course');
            const sectionSelects = document.querySelectorAll('#roster-filter-section, #results-filter-section');

            courseSelects.forEach(select => {
                select.innerHTML = '<option value="all">All Courses</option>'; // Reset
                courses.forEach(course => select.add(new Option(course, course)));
            });
            sectionSelects.forEach(select => {
                select.innerHTML = '<option value="all">All Sections</option>'; // Reset
                sections.forEach(section => select.add(new Option(section, section)));
            });
        }

        // --- MASTER RENDER CONTROLLERS ---
        function updateAllViews() {
            updateRosterView();
            updateResultsView();
            updateAnalysisView();
        }

        function updateRosterView() {
            let data = [...allStudents];
            const state = viewState.roster;
            
            // Apply filters
            if (state.filters.search) {
                const s = state.filters.search.toLowerCase();
                data = data.filter(item => 
                    item.firstname.toLowerCase().includes(s) || 
                    item.lastname.toLowerCase().includes(s) || 
                    item.id_number.includes(s)
                );
            }
            if (state.filters.course !== 'all') data = data.filter(item => item.course === state.filters.course);
            if (state.filters.section !== 'all') data = data.filter(item => item.section === state.filters.section);
            
            // Apply sorting
            data.sort((a, b) => {
                const valA = a[state.sortBy] || '';
                const valB = b[state.sortBy] || '';
                const comparison = valA.localeCompare(valB, undefined, { numeric: true });
                return state.sortDir === 'asc' ? comparison : -comparison;
            });
            
            state.data = data;
            renderTable('students', renderStudentRow, state);
        }

        function updateResultsView() {
            let data = [...allResults];
            const state = viewState.results;

            if (state.filters.course !== 'all') data = data.filter(item => item.course === state.filters.course);
            if (state.filters.section !== 'all') data = data.filter(item => item.section === state.filters.section);

            data.sort((a, b) => {
                const valA = a[state.sortBy];
                const valB = b[state.sortBy];
                return state.sortDir === 'asc' ? valA - valB : valB - valA;
            });
            
            state.data = data;
            renderTable('results', renderResultRow, state);
        }

        function updateAnalysisView() {
            const aisKeywords = ['accounting', 'ais', 'information system'];
            const nosKeywords = ['network', 'nos', 'operating system'];
            
            const aisData = allAnalysis.filter(q => aisKeywords.some(kw => q.question_text.toLowerCase().includes(kw)));
            const nosData = allAnalysis.filter(q => nosKeywords.some(kw => q.question_text.toLowerCase().includes(kw)));
            
            renderAnalysisTable('ais', aisData);
            renderAnalysisTable('nos', nosData);
        }

        // --- GENERIC TABLE RENDERER ---
        function renderTable(tableId, renderRowFunc, state) {
            const tbody = document.getElementById(`${tableId}-tbody`);
            const paginationContainer = document.getElementById(`${tableId}-pagination`);
            tbody.innerHTML = '';
            paginationContainer.innerHTML = '';

            if (state.data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">No data matches your filters.</td></tr>`;
                return;
            }

            const start = (state.currentPage - 1) * state.rowsPerPage;
            const end = start + state.rowsPerPage;
            const paginatedData = state.data.slice(start, end);

            paginatedData.forEach(item => tbody.appendChild(renderRowFunc(item)));

            const pageCount = Math.ceil(state.data.length / state.rowsPerPage);
            if (pageCount > 1) {
                for (let i = 1; i <= pageCount; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = 'btn';
                    if (i === state.currentPage) btn.disabled = true;
                    btn.addEventListener('click', () => {
                        state.currentPage = i;
                        renderTable(tableId, renderRowFunc, state);
                    });
                    paginationContainer.appendChild(btn);
                }
            }
        }

        // --- ROW-SPECIFIC RENDERERS ---
        const renderStudentRow = (student) => {
            const row = document.createElement('tr');
            let status = 'Not Taken', statusClass = 'status-not-taken';
            if (student.exam_taken_at) { status = 'Completed'; statusClass = 'status-completed'; }
            else if (student.exam_started_at) { status = 'In Progress'; statusClass = 'status-in-progress'; }
            const actionBtn = (student.exam_started_at || student.exam_taken_at) ? `<button class="btn btn-retake" data-id="${student.id}">Allow Retake</button>` : 'N/A';
            row.innerHTML = `<td>${student.firstname} ${student.lastname}</td><td>${student.id_number}</td><td>${student.course || ''}</td><td>${student.section || ''}</td><td><span class="${statusClass}">${status}</span></td><td>${actionBtn}</td>`;
            return row;
        };
        
        const renderResultRow = (result) => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${result.name}</td><td>${result.course || ''}</td><td>${result.section || ''}</td><td>${result.score}/${result.totalquestions}</td><td>${result.examtitle}</td><td>${new Date(result.submissiontime).toLocaleString()}</td><td><button class="btn btn-delete" data-id="${result.id}">Delete</button></td>`;
            return row;
        };

        function renderAnalysisTable(type, data) {
            const tbody = document.getElementById(`analysis-tbody-${type}`);
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No analysis data available.</td></tr>`;
                return;
            }
            data.forEach(item => {
                const row = document.createElement('tr');
                const successRate = (item.total_attempts > 0) ? ((item.correct_answers / item.total_attempts) * 100).toFixed(1) + '%' : '0%';
                row.innerHTML = `<td>${item.question_text}</td><td>${item.total_attempts}</td><td>${item.correct_answers}</td><td>${successRate}</td>`;
                tbody.appendChild(row);
            });
        }
        
        function updateSummaryCards() { /* ... unchanged ... */ }
        function getAdminKey() { if (!adminKey) adminKey = prompt('Please enter Admin Secret Key:'); return adminKey; }

        // --- EVENT LISTENERS ---
        // Tab switching
        tabButtons.forEach(button => { button.addEventListener('click', () => { tabButtons.forEach(btn => btn.classList.remove('active')); tabContents.forEach(content => content.classList.remove('active')); button.classList.add('active'); document.getElementById(button.dataset.tab).classList.add('active'); }); });
        
        // Roster filters
        document.getElementById('search-students').addEventListener('input', e => { viewState.roster.filters.search = e.target.value; viewState.roster.currentPage = 1; updateRosterView(); });
        document.getElementById('roster-filter-course').addEventListener('change', e => { viewState.roster.filters.course = e.target.value; viewState.roster.currentPage = 1; updateRosterView(); });
        document.getElementById('roster-filter-section').addEventListener('change', e => { viewState.roster.filters.section = e.target.value; viewState.roster.currentPage = 1; updateRosterView(); });
        document.getElementById('roster-rows-per-page').addEventListener('change', e => { viewState.roster.rowsPerPage = parseInt(e.target.value, 10); viewState.roster.currentPage = 1; updateRosterView(); });

        // Results filters
        document.getElementById('results-filter-course').addEventListener('change', e => { viewState.results.filters.course = e.target.value; viewState.results.currentPage = 1; updateResultsView(); });
        document.getElementById('results-filter-section').addEventListener('change', e => { viewState.results.filters.section = e.target.value; viewState.results.currentPage = 1; updateResultsView(); });
        document.getElementById('results-rows-per-page').addEventListener('change', e => { viewState.results.rowsPerPage = parseInt(e.target.value, 10); viewState.results.currentPage = 1; updateResultsView(); });
        
        // Sorting listeners
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sortKey;
                const state = viewState[th.closest('.tab-content').id]; // roster or results
                if (state.sortBy === key) {
                    state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    state.sortBy = key;
                    state.sortDir = 'asc';
                }
                document.querySelectorAll('.sort-arrow').forEach(a => a.textContent = '');
                th.querySelector('.sort-arrow').textContent = state.sortDir === 'asc' ? '▲' : '▼';
                state.currentPage = 1;
                updateAllViews();
            });
        });

        // Event delegation for action buttons (delete, retake)
        document.body.addEventListener('click', async (event) => { /* ... unchanged ... */ });
    </script>
</body>
</html>
