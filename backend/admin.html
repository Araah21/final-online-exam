<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exam Admin Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background-color: #f8f9fa; color: #212529; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { color: #343a40; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; }
        .btn { padding: 10px 15px; font-size: 14px; cursor: pointer; text-decoration: none; color: #fff; border: none; border-radius: 5px; box-shadow: 0 2px #666; transition: all 0.2s ease; }
        .btn:active { box-shadow: 0 0 #666; transform: translateY(2px); }
        .btn-download { background-color: #28a745; }
        .btn-clear { background-color: #dc3545; }
        .btn-delete { background-color: #ffc107; color: #212529; padding: 5px 10px; font-size: 12px; }
        .btn-retake { background-color: #17a2b8; padding: 5px 10px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #dee2e6; text-align: left; }
        th { background-color: #e9ecef; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .status-completed { color: #28a745; font-weight: bold; }
        .status-not-taken { color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exam Admin Dashboard</h1>
        
        <h2>Student Roster & Exam Status</h2>
        <table id="students-table">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>ID Number</th>
                    <th>Exam Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="students-tbody"></tbody>
        </table>

        <h2>Exam Results</h2>
        <div class="controls">
            <a href="/download-results" class="btn btn-download">Download All as CSV</a>
            <button id="clear-all-btn" class="btn btn-clear">Clear All Results</button>
        </div>
        <table id="results-table">
            <thead>
                <tr>
                    <th>Result ID</th>
                    <th>Name</th>
                    <th>ID Number</th>
                    <th>Exam Title</th>
                    <th>Score</th>
                    <th>Submitted At</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="results-tbody"></tbody>
        </table>
    </div>

    <script>
        const resultsTbody = document.getElementById('results-tbody');
        const studentsTbody = document.getElementById('students-tbody');
        const clearAllBtn = document.getElementById('clear-all-btn');
        let adminKey = '';

        function getAdminKey() {
            if (!adminKey) {
                adminKey = prompt('Please enter the Admin Secret Key to perform this action:');
            }
            return adminKey;
        }

        async function fetchAndDisplayResults() {
            try {
                const response = await fetch('/api/results');
                if (!response.ok) throw new Error('Failed to fetch results.');
                const results = await response.json();
                resultsTbody.innerHTML = ''; 
                if (results.length === 0) {
                    resultsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No results found.</td></tr>';
                    return;
                }
                results.forEach(result => {
                    const row = document.createElement('tr');
                    const submittedAt = new Date(result.submissiontime).toLocaleString();
                    row.innerHTML = `
                        <td>${result.id}</td>
                        <td>${result.name}</td>
                        <td>${result.idnumber}</td>
                        <td>${result.examtitle}</td>
                        <td>${result.score} / ${result.totalquestions}</td>
                        <td>${submittedAt}</td>
                        <td><button class="btn btn-delete" data-id="${result.id}">Delete</button></td>
                    `;
                    resultsTbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading results:', error);
                resultsTbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Error loading results.</td></tr>`;
            }
        }

        async function fetchAndDisplayStudents() {
            try {
                const response = await fetch('/api/students');
                if (!response.ok) throw new Error('Failed to fetch students.');
                const students = await response.json();
                studentsTbody.innerHTML = '';
                students.forEach(student => {
                    const row = document.createElement('tr');
                    const status = student.exam_taken_at 
                        ? `<span class="status-completed">Completed at ${new Date(student.exam_taken_at).toLocaleTimeString()}</span>`
                        : `<span class="status-not-taken">Not Taken</span>`;
                    const actionButton = student.exam_taken_at
                        ? `<button class="btn btn-retake" data-id="${student.id}">Allow Retake</button>`
                        : 'N/A';
                    
                    row.innerHTML = `
                        <td>${student.firstname} ${student.lastname}</td>
                        <td>${student.id_number}</td>
                        <td>${status}</td>
                        <td>${actionButton}</td>
                    `;
                    studentsTbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading students:', error);
                studentsTbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Error loading student roster.</td></tr>`;
            }
        }

        resultsTbody.addEventListener('click', async (event) => {
            if (event.target.classList.contains('btn-delete')) {
                const resultId = event.target.dataset.id;
                if (!confirm(`Are you sure you want to delete result ID #${resultId}?`)) return;
                const key = getAdminKey();
                if (!key) return;

                try {
                    const response = await fetch(`/api/results/${resultId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ adminKey: key })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    alert(data.message);
                    fetchAndDisplayResults();
                    fetchAndDisplayStudents(); // Refresh student status as well
                } catch (error) {
                    alert(`Error: ${error.message}`);
                    adminKey = '';
                }
            }
        });

        studentsTbody.addEventListener('click', async (event) => {
            if (event.target.classList.contains('btn-retake')) {
                const studentId = event.target.dataset.id;
                if (!confirm(`Are you sure you want to allow student ID #${studentId} to retake the exam? Their previous result will NOT be deleted.`)) return;
                const key = getAdminKey();
                if (!key) return;

                try {
                    const response = await fetch(`/api/students/${studentId}/reset`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ adminKey: key })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    alert(data.message);
                    fetchAndDisplayStudents(); // Refresh the student list
                } catch (error) {
                    alert(`Error: ${error.message}`);
                    adminKey = '';
                }
            }
        });

        clearAllBtn.addEventListener('click', async () => {
            if (!confirm('ARE YOU SURE you want to permanently delete ALL exam results? This action cannot be undone.')) return;
            const key = getAdminKey();
            if (!key) return;

            try {
                const response = await fetch('/api/results/all', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminKey: key })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                alert(data.message);
                fetchAndDisplayResults();
                fetchAndDisplayStudents(); // Refresh student status as well
            } catch (error) {
                alert(`Error: ${error.message}`);
                adminKey = '';
            }
        });

        // Initial load of both tables
        fetchAndDisplayResults();
        fetchAndDisplayStudents();
    </script>
</body>
</html>